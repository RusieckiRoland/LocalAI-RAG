<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Aplikacja do zapyta≈Ñ RAG z konsultantami.">
  <title>Zapytanie RAG</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/csharp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Noto Sans', sans-serif; line-height: 1.6; background:#f9fafb; }

    /* Layout */
    #chat-container { display: flex; flex-direction: column; height: 100%; position: relative; }
    #response { display: flex; flex-direction: column-reverse; overflow-y: auto; padding: 0 1rem 1rem 1rem; flex-grow: 1; }
    .response-entry { margin-bottom: 1rem; }

    /* Header bar */
    .topbar {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      padding: .5rem .75rem;
      border-radius: .75rem;
      margin: .75rem 1rem .5rem 1rem;

      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: .75rem;
    }

    /* Consultant tabs */
    #consultants { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:center; }

    .consultant-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.45rem 0.65rem;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      cursor: pointer;
      background: #ffffff;
      transition: background-color 0.15s, border-color 0.15s, box-shadow 0.15s;
      min-height: 44px;
    }
    .consultant-card:hover { background-color: #f9fafb; }
    .consultant-card.active {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.10);
      background-color: #eff6ff;
    }

    .consultant-icon {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 18px;
      flex: 0 0 auto;
    }
    .consultant-text { display:flex; flex-direction:column; line-height:1.1; }
    .consultant-name { font-weight: 700; color:#111827; font-size: 0.95rem; }
    .consultant-desc { font-size: 0.75rem; color:#6b7280; margin-top:2px; }

    /* Dev badge */
    .dev-badge {
      position: fixed;
      top: .5rem;
      right: .5rem;
      background: #fde68a;
      color: #92400e;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      opacity: 0.9;
      z-index: 50;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    /* New chat button (in topbar, left) */
    .topbar-newchat {
      background:#2563eb;
      color:#fff;
      border-radius:.75rem;
      padding:.55rem .9rem;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.45rem;
      height: 44px;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .topbar-newchat:hover { background:#1d4ed8; }

    .topbar-spacer { width: 1px; height: 1px; }

    /* Form */
    #queryForm {
      background-color: white;
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.06);
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin: 0 1rem 1rem 1rem;
    }

    #queryForm.centered {
      position: absolute;
      top: 52%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: calc(100% - 2rem);
      max-width: 1050px;
      margin: 0;
      border-radius: 1rem;
      border: 1px solid #eef2f7;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }

    .welcome-message {
      text-align: center;
      font-size: 1.55rem;
      font-weight: 800;
      color: #111827;
      margin: 0.25rem 0 0.25rem 0;
      display: block;
    }
    #queryForm.centered .welcome-message { display: block; }
    #queryForm:not(.centered) .welcome-message { display: none; }

    .welcome-message a {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-color: #bfdbfe;
      transition: color .2s ease, text-decoration-color .2s ease;
    }
    .welcome-message a:hover,
    .welcome-message a:focus-visible {
      color: #1d4ed8;
      text-decoration-color: #60a5fa;
      outline: none;
    }

    /* Inputs */
    .input-field {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem 0.9rem;
      background-color: white;
      outline: none;
    }
    .input-field:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .select-field {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.45rem 0.75rem;
      background-color: white;
      outline: none;
      height: 40px;
      line-height: 40px;
      min-width: 220px;
    }
    .select-field:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    /* Controls row */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: nowrap;
    }

    .branch-controls {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex: 1 1 auto;
      min-width: 0;
      padding-right: 0.25rem;
      border-right: 1px solid #eef2f7;
    }

    .branch-label {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      color: #111827;
      font-weight: 700;
      font-size: 0.9rem;
      white-space: nowrap;
      padding: 0.45rem 0.65rem;
      background: #f8fafc;
      border: 1px solid #eef2f7;
      border-radius: 0.75rem;
      height: 40px;
      flex: 0 0 auto;
    }

    .branch-select {
      height: 40px;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.45rem 2.25rem 0.45rem 0.75rem;
      background: #ffffff;
      outline: none;

      min-width: 160px;
      max-width: 520px;

      width: auto;
      flex: 0 1 auto;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .branch-select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .branch-controls.compare .branch-select {
      max-width: 520px;
      flex: 0 1 auto;
      min-width: 160px;
    }

    .vs-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 40px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-weight: 800;
      color: #374151;
      flex: 0 0 auto;
    }

    .actions-controls {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex: 0 0 auto;
      padding-left: 0.25rem;
      white-space: nowrap;
    }

    .lang-select {
      min-width: 240px;
      max-width: 280px;
      height: 40px;
    }

    .send-btn {
      background-color: #2563eb;
      color: white;
      padding: 0 1.0rem;
      border-radius: 0.75rem;
      height: 40px;
      font-weight: 700;
      transition: background-color 0.15s;
      min-width: 92px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn:hover { background-color: #1d4ed8; }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Medium: wrap cleanly */
    @media (max-width: 820px) {
      .controls-row { flex-wrap: wrap; }
      .branch-controls {
        flex: 1 1 100%;
        border-right: none;
        padding-right: 0;
      }
      .actions-controls {
        flex: 1 1 100%;
        justify-content: flex-end;
      }
      .lang-select { min-width: 220px; }
      .branch-select { max-width: none; }
    }

    /* Small: stop the "syf" and STACK everything */
    @media (max-width: 520px) {
      .topbar { grid-template-columns: 1fr; gap: .6rem; }
      #consultants { justify-content: center; }
      .topbar-spacer { display:none; }
      .topbar-newchat { width: 100%; }

      .branch-controls {
        flex-wrap: wrap;
        gap: .5rem;
      }

      .branch-label { height: 40px; }

      .branch-select {
        width: 100% !important;
        max-width: none !important;
        flex: 1 1 100% !important;
        min-width: 0 !important;
      }

      .vs-badge {
        margin: 0 auto;
      }

      .actions-controls {
        flex-wrap: wrap;
        justify-content: stretch;
        gap: .5rem;
      }

      .lang-select {
        min-width: 0;
        max-width: none;
        width: 100%;
        flex: 1 1 100%;
      }

      .send-btn {
        width: 100%;
        flex: 1 1 100%;
        min-width: 0;
      }
    }

    /* Markdown */
    .markdown-content { color: #374151; }
    .markdown-content pre {
      background-color: #1e1e1e; padding: 1em; border-radius: 0.75em;
      overflow-x: auto; margin-bottom: 1.25em; position: relative;
    }
    .markdown-content pre code { background-color: transparent; padding: 0; color: #d4d4d4; }

    .copy-btn {
      position: absolute; right: 0.5em; top: 0.5em;
      background-color: #3b82f6; color: white; border: none; border-radius: 0.5em;
      padding: 0.25em 0.55em; font-size: 0.75em; cursor: pointer; opacity: 0;
      transition: opacity 0.2s;
    }
    pre:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { background-color: #2563eb; }
    .copy-btn.copied { background-color: #10b981; }

    .ui-error {
      margin: 0.0rem 1rem 0.5rem 1rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #991b1b;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      display: none;
    }
  </style>
</head>

<body>
  <div class="dev-badge">Development Mode</div>

  <div class="max-w-7xl mx-auto h-screen" id="chat-container">
    <div class="topbar">
      <button onclick="newChat()" class="topbar-newchat" id="newChatBtn">‚ôªÔ∏è Nowy Chat</button>
      <div class="flex gap-2" id="consultants"></div>
      <div class="topbar-spacer" aria-hidden="true"></div>
    </div>

    <div class="ui-error" id="uiError"></div>

    <div id="response"></div>

    <form id="queryForm">
      <div class="welcome-message" id="welcomeMessage"></div>

      <textarea id="query" placeholder="Wpisz pytanie..." class="input-field w-full"></textarea>

      <div class="controls-row">
        <div class="branch-controls" id="branchControls">
          <!-- Rendered by JS -->
        </div>

        <div class="actions-controls">
          <select id="lang" class="select-field lang-select">
            <option value="pl">PL Rozmawiaj po polsku</option>
            <option value="en">EN English (no translation)</option>
          </select>

          <button type="submit" class="send-btn" id="sendBtn">Wy≈õlij</button>
        </div>
      </div>
    </form>
  </div>

<script>
  // English comments only.

  const API_BASE = (window.location.protocol === "file:")
    ? "http://localhost:8081"
    : window.location.origin;

  let sessionId = localStorage.getItem("sessionId") || null;

  let selectedConsultant = null;
  let appConfig = null;
  let consultantsById = {};
  let branches = [];

  let selectedBranchA = null;
  let selectedBranchB = null;

  const form = document.getElementById("queryForm");
  const queryInput = document.getElementById("query");
  const responseDiv = document.getElementById("response");
  const submitButton = document.getElementById("sendBtn");
  const welcomeMessage = document.getElementById("welcomeMessage");
  const langSelect = document.getElementById("lang");
  const consultantsContainer = document.getElementById("consultants");
  const newChatBtn = document.getElementById("newChatBtn");
  const uiError = document.getElementById("uiError");
  const branchControls = document.getElementById("branchControls");

  // If name is longer than this, we shorten it in CLOSED state.
  // In compare mode we also shorten even if it's below the threshold (to make differences obvious).
  const MAX_BRANCH_LABEL_LEN = 28;

  const uiTexts = {
    pl: {
      send: "Wy≈õlij",
      wait: "Czekaj...",
      error: "WystƒÖpi≈Ç b≈ÇƒÖd podczas przetwarzania zapytania.",
      noResponse: "Brak odpowiedzi",
      ask: "zapytanie",
      placeholder: "Wpisz pytanie...",
      newChat: "‚ôªÔ∏è Nowy Chat",
      locale: "pl-PL",
      copy: "Kopiuj",
      copied: "Skopiowano!",
      branchLabel: "Branch",
      vs: "vs"
    },
    en: {
      send: "Send",
      wait: "Please wait...",
      error: "An error occurred while processing the request.",
      noResponse: "No response",
      ask: "query",
      placeholder: "Type your question...",
      newChat: "‚ôªÔ∏è New Chat",
      locale: "en-GB",
      copy: "Copy",
      copied: "Copied!",
      branchLabel: "Branch",
      vs: "vs"
    }
  };

  function showUiError(msg) {
    if (!uiError) return;
    uiError.textContent = msg || "";
    uiError.style.display = msg ? "block" : "none";
  }

  function getCurrentLang() {
    return localStorage.getItem("lang") || (langSelect?.value || "pl");
  }

  function getTexts(lang) {
    return uiTexts[lang] || uiTexts.pl;
  }

  async function fetchAppConfig() {
    const res = await fetch(`${API_BASE}/app-config`);
    if (!res.ok) throw new Error(`GET /app-config failed: ${res.status}`);
    return await res.json();
  }

  function rebuildConsultantsIndex() {
    consultantsById = {};
    for (const c of (appConfig?.consultants || [])) {
      consultantsById[c.id] = c;
    }
    branches = Array.isArray(appConfig?.branches) ? appConfig.branches : [];
  }

  function buildConsultantsBar(lang) {
    consultantsContainer.innerHTML = "";

    for (const c of (appConfig?.consultants || [])) {
      const desc = c.cardDescription?.[lang] || c.cardDescription?.pl || "";

      const card = document.createElement("div");
      card.className = "consultant-card";
      card.setAttribute("data-consultant-id", c.id);
      card.addEventListener("click", () => selectConsultant(c.id));

      const icon = document.createElement("div");
      icon.className = "consultant-icon";
      icon.textContent = c.icon || "üë§";

      const textWrap = document.createElement("div");
      textWrap.className = "consultant-text";

      const nameSpan = document.createElement("div");
      nameSpan.className = "consultant-name";
      nameSpan.textContent = c.displayName || c.id;

      const small = document.createElement("div");
      small.className = "consultant-desc";
      small.textContent = desc;

      textWrap.appendChild(nameSpan);
      textWrap.appendChild(small);

      card.appendChild(icon);
      card.appendChild(textWrap);

      consultantsContainer.appendChild(card);
    }

    document.querySelectorAll(".consultant-card").forEach(el => {
      const id = el.getAttribute("data-consultant-id");
      el.classList.toggle("active", id === selectedConsultant);
    });
  }

  function renderWelcomeMessage(lang = getCurrentLang()) {
    const c = consultantsById[selectedConsultant];
    if (!welcomeMessage) return;

    if (!c) {
      welcomeMessage.textContent = "";
      return;
    }

    const template = c.welcomeTemplate?.[lang] || c.welcomeTemplate?.pl || "";
    const href = c.wikiUrl?.[lang] || c.wikiUrl?.pl || "";

    const linkText =
      c.welcomeLinkText?.[lang] ||
      c.welcomeLinkText?.pl ||
      c.displayName ||
      c.id;

    const parts = String(template).split("{link}");
    const before = parts[0] ?? "";
    const after = parts.slice(1).join("{link}") ?? "";

    welcomeMessage.innerHTML = "";
    welcomeMessage.appendChild(document.createTextNode(before));

    const a = document.createElement("a");
    a.href = href || "#";
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.title = (lang === "pl") ? "Wikipedia ‚Äì otwiera siƒô w nowej karcie" : "Wikipedia ‚Äì opens in new tab";
    a.textContent = linkText;

    if (!href) {
      a.removeAttribute("href");
      a.style.textDecoration = "none";
      a.style.color = "inherit";
      a.style.cursor = "default";
    }

    welcomeMessage.appendChild(a);
    welcomeMessage.appendChild(document.createTextNode(after));
  }

  function firstBranchOrNull() {
    return branches.length ? branches[0] : null;
  }

  function secondBranchOrFirst() {
    if (branches.length >= 2) return branches[1];
    return branches.length ? branches[0] : null;
  }

  // Autosize select width to its selected option text (clamped).
  const __selectMeasureSpan = (() => {
    const s = document.createElement("span");
    s.style.position = "absolute";
    s.style.visibility = "hidden";
    s.style.whiteSpace = "pre";
    s.style.top = "-9999px";
    s.style.left = "-9999px";
    document.body.appendChild(s);
    return s;
  })();

  function autoSizeSelectToValue(selectEl, opts = {}) {
    if (!selectEl) return;

    const minPx = opts.minPx ?? 160;
    const maxPx = opts.maxPx ?? 520;

    const text = selectEl.options?.[selectEl.selectedIndex]?.text ?? "";
    const cs = window.getComputedStyle(selectEl);

    __selectMeasureSpan.style.fontFamily = cs.fontFamily;
    __selectMeasureSpan.style.fontSize = cs.fontSize;
    __selectMeasureSpan.style.fontWeight = cs.fontWeight;
    __selectMeasureSpan.style.letterSpacing = cs.letterSpacing;

    __selectMeasureSpan.textContent = text;

    const textWidth = __selectMeasureSpan.getBoundingClientRect().width;

    // Room for paddings + native arrow + safety.
    const extra = 80;

    const target = Math.ceil(textWidth + extra);
    const clamped = Math.max(minPx, Math.min(maxPx, target));

    selectEl.style.width = `${clamped}px`;
  }

  function autoSizeAllBranchSelects() {
    document.querySelectorAll("select.branch-select").forEach(sel => autoSizeSelectToValue(sel));
  }

  function commonPrefixLen(strings) {
    if (!strings || strings.length === 0) return 0;
    const s0 = String(strings[0] ?? "");
    let i = 0;
    while (i < s0.length) {
      const ch = s0[i];
      for (let k = 1; k < strings.length; k++) {
        const sk = String(strings[k] ?? "");
        if (i >= sk.length || sk[i] !== ch) return i;
      }
      i++;
    }
    return i;
  }

  function commonSuffixLen(strings) {
    if (!strings || strings.length === 0) return 0;
    const s0 = String(strings[0] ?? "");
    let i = 0;
    while (i < s0.length) {
      const ch = s0[s0.length - 1 - i];
      for (let k = 1; k < strings.length; k++) {
        const sk = String(strings[k] ?? "");
        if (i >= sk.length || sk[sk.length - 1 - i] !== ch) return i;
      }
      i++;
    }
    return i;
  }

  function trimLeadingSeparators(s) {
    return String(s).replace(/^[_\-.\/\\\s]+/, "");
  }

  function trimTrailingSeparators(s) {
    return String(s).replace(/[_\-.\/\\\s]+$/, "");
  }

  function computeClosedBranchLabel(fullName, mode) {
    const name = String(fullName ?? "");
    if (!name) return "";

    const inCompare = (mode === "compare");

    // Single mode: show full if "reasonable".
    // Compare mode: force smart-shortening to make A vs B obvious.
    const shouldShorten = inCompare || (name.length > MAX_BRANCH_LABEL_LEN);
    if (!shouldShorten) return name;

    if (!Array.isArray(branches) || branches.length <= 1) {
      if (name.length <= MAX_BRANCH_LABEL_LEN) return name;
      return "‚Ä¶" + name.slice(-(MAX_BRANCH_LABEL_LEN - 1));
    }

    const pref = commonPrefixLen(branches);
    const suff = commonSuffixLen(branches);

    // Candidate A: cut common PREFIX, keep the differing tail.
    let candPrefix = null;
    if (pref > 0 && pref < name.length) {
      const tail = trimLeadingSeparators(name.slice(pref));
      if (tail) candPrefix = "‚Ä¶" + tail;
    }

    // Candidate B: cut common SUFFIX, keep the differing head.
    let candSuffix = null;
    if (suff > 0 && suff < name.length) {
      const head = trimTrailingSeparators(name.slice(0, name.length - suff));
      if (head) candSuffix = head + "‚Ä¶";
    }

    // Prefer cutting the side that is more common across all names.
    let chosen = null;
    if (pref >= suff) {
      chosen = candPrefix || candSuffix || name;
    } else {
      chosen = candSuffix || candPrefix || name;
    }

    if (chosen.length <= MAX_BRANCH_LABEL_LEN) return chosen;

    if (chosen.startsWith("‚Ä¶")) {
      return "‚Ä¶" + name.slice(-(MAX_BRANCH_LABEL_LEN - 1));
    }
    return name.slice(0, MAX_BRANCH_LABEL_LEN - 1) + "‚Ä¶";
  }

  function setAllOptionsToFull(selectEl) {
    if (!selectEl) return;
    for (const opt of selectEl.options) {
      const full = opt.getAttribute("data-full");
      if (full != null) opt.textContent = full;
    }
  }

  function applyClosedLabelToSelected(selectEl, mode) {
    if (!selectEl) return;

    setAllOptionsToFull(selectEl);

    const full = String(selectEl.value ?? "");
    const label = computeClosedBranchLabel(full, mode);

    const opt = selectEl.options?.[selectEl.selectedIndex];
    if (opt) opt.textContent = label;

    selectEl.title = full || "";

    autoSizeSelectToValue(selectEl);
  }

  function prepareOpenSelect(selectEl) {
    setAllOptionsToFull(selectEl);
  }

  function renderBranchControls() {
    const lang = getCurrentLang();
    const t = getTexts(lang);
    const c = consultantsById[selectedConsultant];

    branchControls.innerHTML = "";

    const label = document.createElement("div");
    label.className = "branch-label";
    label.innerHTML = `üîÄ <span>${t.branchLabel}</span>`;
    branchControls.appendChild(label);

    const mode = (c && c.branchPickerMode) ? c.branchPickerMode : "single";
    branchControls.classList.toggle("compare", mode === "compare");

    if (!selectedBranchA) selectedBranchA = firstBranchOrNull();
    if (mode === "compare") {
      if (!selectedBranchB) selectedBranchB = secondBranchOrFirst();
    } else {
      selectedBranchB = null;
    }

    const makeSelect = (currentValue, onChange) => {
      const sel = document.createElement("select");
      sel.className = "branch-select";

      for (const b of branches) {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        opt.setAttribute("data-full", b);
        sel.appendChild(opt);
      }

      if (currentValue && branches.includes(currentValue)) {
        sel.value = currentValue;
      } else if (branches.length) {
        sel.value = branches[0];
      }

      sel.addEventListener("focus", () => prepareOpenSelect(sel));
      sel.addEventListener("mousedown", () => prepareOpenSelect(sel));
      sel.addEventListener("keydown", (e) => {
        if (e.key === "ArrowDown" || e.key === " " || e.key === "Enter") {
          prepareOpenSelect(sel);
        }
      });

      sel.addEventListener("change", (e) => {
        onChange(e.target.value);
        setTimeout(() => applyClosedLabelToSelected(sel, mode), 0);
      });

      sel.addEventListener("blur", () => applyClosedLabelToSelected(sel, mode));

      applyClosedLabelToSelected(sel, mode);

      return sel;
    };

    const selA = makeSelect(selectedBranchA, v => selectedBranchA = v);
    branchControls.appendChild(selA);

    if (mode === "compare") {
      const vs = document.createElement("div");
      vs.className = "vs-badge";
      vs.textContent = t.vs;
      branchControls.appendChild(vs);

      const selB = makeSelect(selectedBranchB, v => selectedBranchB = v);
      branchControls.appendChild(selB);
    }

    requestAnimationFrame(autoSizeAllBranchSelects);
  }

  function refreshCopyButtonsText(lang) {
    const t = getTexts(lang);
    document.querySelectorAll(".copy-btn").forEach(btn => {
      const isCopied = btn.classList.contains("copied");
      btn.textContent = isCopied ? t.copied : t.copy;
    });
  }

  function applyLang(lang) {
    const t = getTexts(lang);

    if (submitButton) submitButton.innerText = t.send;
    if (queryInput) queryInput.placeholder = t.placeholder;
    if (newChatBtn) newChatBtn.textContent = t.newChat;

    localStorage.setItem("lang", lang);
    if (langSelect && langSelect.value !== lang) langSelect.value = lang;

    buildConsultantsBar(lang);
    renderWelcomeMessage(lang);
    renderBranchControls();

    // Fix: existing copy buttons must update when language changes.
    refreshCopyButtonsText(lang);
  }

  function selectConsultant(id) {
    selectedConsultant = id;

    document.querySelectorAll(".consultant-card").forEach(el => {
      const cid = el.getAttribute("data-consultant-id");
      el.classList.toggle("active", cid === id);
    });

    renderWelcomeMessage(getCurrentLang());
    renderBranchControls();
  }

  function newChat() {
    sessionId = null;
    localStorage.removeItem("sessionId");
    responseDiv.innerHTML = "";
    updateFormPosition();
  }

  function updateFormPosition() {
    const isEmpty = responseDiv.children.length === 0;
    form.classList.toggle("centered", isEmpty);
  }

  function addCopyButtons() {
    document.querySelectorAll("pre").forEach(pre => {
      if (pre.querySelector(".copy-btn")) return;

      const button = document.createElement("button");
      button.className = "copy-btn";
      const t = getTexts(getCurrentLang());
      button.textContent = t.copy;

      button.addEventListener("click", e => {
        e.preventDefault();
        const code = pre.querySelector("code")?.textContent || "";
        navigator.clipboard.writeText(code).then(() => {
          const t2 = getTexts(getCurrentLang());
          button.textContent = t2.copied;
          button.classList.add("copied");
          setTimeout(() => {
            const t3 = getTexts(getCurrentLang());
            button.textContent = t3.copy;
            button.classList.remove("copied");
          }, 2000);
        });
      });

      pre.appendChild(button);
    });
  }

  function scrollToLatestResponse() {
    if (responseDiv.firstChild) {
      responseDiv.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      }
      return hljs.highlightAuto(code).value;
    }
  });

  async function handleSubmit(e) {
    e.preventDefault();
    const lang = getCurrentLang();
    const t = getTexts(lang);

    let query = (queryInput.value || "").trim();
    if (!query || query.length > 1000) {
      if (query.length > 1000) alert(t.error + " (Za d≈Çugie zapytanie)");
      return;
    }

    submitButton.disabled = true;
    submitButton.innerText = t.wait;

    const c = consultantsById[selectedConsultant];
    const mode = (c && c.branchPickerMode) ? c.branchPickerMode : "single";

    const body = {
      query: query,
      consultant: selectedConsultant,
      translateChat: (lang === "pl"),
      branchA: selectedBranchA,
      branchB: (mode === "compare") ? selectedBranchB : null
    };

    try {
      const res = await fetch(`${API_BASE}/search`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(sessionId ? { "X-Session-ID": sessionId } : {})
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error(`POST /search failed: ${res.status}`);

      const json = await res.json();
      if (json.session_id) {
        sessionId = json.session_id;
        localStorage.setItem("sessionId", sessionId);
      }

      const markdown = json.results || t.noResponse;
      const html = marked.parse(markdown);
      const timestamp = new Date().toLocaleString(t.locale);

      const questionHTML = `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 response-entry">
          <div class="text-sm text-gray-500 mb-2">
            ${timestamp} ${t.ask}: <i>${escapeHtml(query)}</i>
          </div>
          <div class="markdown-content text-gray-900">${html}</div>
        </div>
      `;

      responseDiv.innerHTML = questionHTML + responseDiv.innerHTML;
      queryInput.value = "";
      addCopyButtons();
      scrollToLatestResponse();
    } catch (error) {
      console.error("submit:", error);
      alert(t.error);
    } finally {
      submitButton.disabled = false;
      submitButton.innerText = t.send;
      updateFormPosition();
      localStorage.setItem("lang", lang);
    }
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function bootstrapUi() {
    try {
      showUiError("");
      appConfig = await fetchAppConfig();
      rebuildConsultantsIndex();

      selectedConsultant =
        appConfig.defaultConsultantId ||
        (appConfig.consultants?.[0]?.id ?? null);

      selectedBranchA = firstBranchOrNull();
      selectedBranchB = secondBranchOrFirst();

      const savedLang = getCurrentLang();
      applyLang(savedLang);

      updateFormPosition();
      queryInput.focus();
    } catch (e) {
      console.error("bootstrapUi:", e);
      showUiError(
        `Failed to load configuration from z ${API_BASE}/app-config. ` +
        `If you opened this page as a local file (file://), start the mock server (server.js) on http://localhost:8081 and refresh the page.`
      );
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (langSelect) {
      const savedLang = getCurrentLang();
      langSelect.value = savedLang;
      langSelect.addEventListener("change", e => applyLang(e.target.value));
    }

    window.addEventListener("resize", () => {
      autoSizeAllBranchSelects();
    });

    form.addEventListener("submit", handleSubmit);

    queryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit", { cancelable: true }));
      }
    });

    bootstrapUi();
  });
</script>

</body>
</html>
