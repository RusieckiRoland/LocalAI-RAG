<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Aplikacja do zapyta≈Ñ RAG z konsultantami.">
  <title>Zapytanie RAG</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/csharp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Noto Sans', sans-serif; line-height: 1.6; background:#f9fafb; }

    /* Layout */
    #chat-container { display: flex; flex-direction: column; height: 100%; position: relative; }
    #response { display: flex; flex-direction: column-reverse; overflow-y: auto; padding: 0 1rem 1rem 1rem; flex-grow: 1; }
    .response-entry { margin-bottom: 1rem; }

    /* Header bar */
    .topbar {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      padding: .5rem .75rem;
      border-radius: .75rem;
      margin: .75rem 1rem .5rem 1rem;

      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: .75rem;
    }

    /* Consultant tabs */
    #consultants { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:center; }

    .consultant-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.45rem 0.65rem;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      cursor: pointer;
      background: #ffffff;
      transition: background-color 0.15s, border-color 0.15s, box-shadow 0.15s;
      min-height: 44px;
    }
    .consultant-card:hover { background-color: #f9fafb; }
    .consultant-card.active {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.10);
      background-color: #eff6ff;
    }

    .consultant-icon {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 18px;
      flex: 0 0 auto;
    }
    .consultant-text { display:flex; flex-direction:column; line-height:1.1; }
    .consultant-name { font-weight: 700; color:#111827; font-size: 0.95rem; }
    .consultant-desc { font-size: 0.75rem; color:#6b7280; margin-top:2px; }

    /* Dev badge */
    .dev-badge {
      position: fixed;
      top: .5rem;
      right: .5rem;
      background: #fde68a;
      color: #92400e;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      opacity: 0.9;
      z-index: 50;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    /* New chat button (in topbar, left) */
    .topbar-newchat {
      background:#2563eb;
      color:#fff;
      border-radius:.75rem;
      padding:.55rem .9rem;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.45rem;
      height: 44px;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .topbar-newchat:hover { background:#1d4ed8; }

    .topbar-spacer { width: 1px; height: 1px; }

    /* Auth controls (dev only) */
    .auth-controls {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .auth-btn {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0 0.85rem;
      height: 36px;
      font-weight: 700;
      background: #ffffff;
      color: #111827;
      transition: background-color 0.15s, border-color 0.15s, color 0.15s;
      white-space: nowrap;
    }
    .auth-btn:hover { background: #f3f4f6; }
    .auth-btn.active {
      background: #16a34a;
      border-color: #16a34a;
      color: #ffffff;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.12);
    }

    /* Form */
    #queryForm {
      background-color: white;
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.06);
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin: 0 1rem 1rem 1rem;
    }

    #queryForm.centered {
      position: absolute;
      top: 52%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: calc(100% - 2rem);
      max-width: 1050px;
      margin: 0;
      border-radius: 1rem;
      border: 1px solid #eef2f7;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }

    .welcome-message {
      text-align: center;
      font-size: 1.55rem;
      font-weight: 800;
      color: #111827;
      margin: 0.25rem 0 0.25rem 0;
      display: block;
    }
    #queryForm.centered .welcome-message { display: block; }
    #queryForm:not(.centered) .welcome-message { display: none; }

    .welcome-message a {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-color: #bfdbfe;
      transition: color .2s ease, text-decoration-color .2s ease;
    }
    .welcome-message a:hover,
    .welcome-message a:focus-visible {
      color: #1d4ed8;
      text-decoration-color: #60a5fa;
      outline: none;
    }

    /* Inputs */
    .input-field {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem 0.9rem;
      background-color: white;
      outline: none;
    }
    .input-field:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .select-field {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.45rem 0.75rem;
      background-color: white;
      outline: none;
      height: 40px;
      line-height: 40px;
      min-width: 220px;
    }
    .select-field:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    /* Controls row */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: nowrap;
    }

    .branch-controls {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex: 1 1 auto;
      min-width: 0;
      padding-right: 0.25rem;
      border-right: 1px solid #eef2f7;
    }

    .branch-label {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      color: #111827;
      font-weight: 700;
      font-size: 0.9rem;
      white-space: nowrap;
      padding: 0.45rem 0.65rem;
      background: #f8fafc;
      border: 1px solid #eef2f7;
      border-radius: 0.75rem;
      height: 40px;
      flex: 0 0 auto;
    }

    .branch-select {
      height: 40px;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.45rem 2.25rem 0.45rem 0.75rem;
      background: #ffffff;
      outline: none;

      min-width: 160px;
      max-width: 520px;

      width: auto;
      flex: 0 1 auto;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .branch-select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .branch-controls.compare .branch-select {
      max-width: 520px;
      flex: 0 1 auto;
      min-width: 160px;
    }

    .vs-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 40px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-weight: 800;
      color: #374151;
      flex: 0 0 auto;
    }

    .branch-none-hint {
      display: inline-flex;
      align-items: center;
      height: 40px;
      padding: 0 0.75rem;
      border-radius: 0.75rem;
      background: #f3f4f6;
      border: 1px dashed #e5e7eb;
      color: #374151;
      font-weight: 700;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .actions-controls {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex: 0 0 auto;
      padding-left: 0.25rem;
      white-space: nowrap;
    }
    .controls-spacer {
      flex: 1 1 auto;
      min-width: 0;
      display: none;
    }

    .lang-select {
      min-width: 240px;
      max-width: 280px;
      height: 40px;
    }

    .send-btn {
      background-color: #2563eb;
      color: white;
      padding: 0 1.0rem;
      border-radius: 0.75rem;
      height: 40px;
      font-weight: 700;
      transition: background-color 0.15s;
      min-width: 92px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn:hover { background-color: #1d4ed8; }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .command-link {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #1d4ed8;
      font-weight: 700;
      text-decoration: none;
      border: 1px solid #c7d2fe;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.12);
    }
    .command-link::before {
      content: "‚Üó";
      font-weight: 800;
    }
    .command-link:hover {
      background: #e0e7ff;
      border-color: #a5b4fc;
    }
    .command-links {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    /* Medium: wrap cleanly */
    @media (max-width: 820px) {
      .controls-row { flex-wrap: wrap; }
      .branch-controls {
        flex: 1 1 100%;
        border-right: none;
        padding-right: 0;
      }
      .controls-spacer { display: none !important; }
      .actions-controls {
        flex: 1 1 100%;
        justify-content: flex-end;
      }
      .lang-select { min-width: 220px; }
      .branch-select { max-width: none; }
    }

    /* Small: stop the "syf" and STACK everything */
    @media (max-width: 520px) {
      .topbar { grid-template-columns: 1fr; gap: .6rem; }
      #consultants { justify-content: center; }
      .topbar-spacer { display:none; }
      .topbar-newchat { width: 100%; }
      .auth-controls { width: 100%; justify-content: center; }
      .auth-btn { width: 100%; }

      .branch-controls {
        flex-wrap: wrap;
        gap: .5rem;
      }

      .branch-label { height: 40px; }

      .branch-select {
        width: 100% !important;
        max-width: none !important;
        flex: 1 1 100% !important;
        min-width: 0 !important;
      }

      .vs-badge {
        margin: 0 auto;
      }

      .actions-controls {
        flex-wrap: wrap;
        justify-content: stretch;
        gap: .5rem;
      }

      .lang-select {
        min-width: 0;
        max-width: none;
        width: 100%;
        flex: 1 1 100%;
      }

      .send-btn {
        width: 100%;
        flex: 1 1 100%;
        min-width: 0;
      }
    }

    /* Markdown */
    .markdown-content { color: #374151; }
    .markdown-content pre {
      background-color: #1e1e1e; padding: 1em; border-radius: 0.75em;
      overflow-x: auto; margin-bottom: 1.25em; position: relative;
    }
    .markdown-content pre code { background-color: transparent; padding: 0; color: #d4d4d4; }

    .copy-btn {
      position: absolute; right: 0.5em; top: 0.5em;
      background-color: #3b82f6; color: white; border: none; border-radius: 0.5em;
      padding: 0.25em 0.55em; font-size: 0.75em; cursor: pointer; opacity: 0;
      transition: opacity 0.2s;
    }
    pre:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { background-color: #2563eb; }
    .copy-btn.copied { background-color: #10b981; }

    .ui-error {
      margin: 0.0rem 1rem 0.5rem 1rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #991b1b;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      display: none;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      width: min(480px, 92vw);
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    .modal-title {
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #111827;
    }
    .modal-body {
      color: #374151;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      white-space: pre-line;
    }
    .modal-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    .modal-btn {
      border-radius: 0.5rem;
      padding: 0.45rem 0.9rem;
      font-weight: 600;
    }
    .modal-btn.cancel {
      background: #e5e7eb;
      color: #111827;
    }
    .modal-btn.confirm {
      background: #2563eb;
      color: white;
    }
  </style>
</head>

<body>
  <div class="dev-badge">Development Mode</div>

  <div class="max-w-7xl mx-auto h-screen" id="chat-container">
    <div class="topbar">
      <button onclick="newChat()" class="topbar-newchat" id="newChatBtn">‚ôªÔ∏è Nowy Chat</button>
      <div class="flex gap-2" id="consultants"></div>
      <div class="auth-controls" id="authControls">
        <button id="authToggleBtn" class="auth-btn" type="button">Fake Login</button>
      </div>
    </div>

    <div class="ui-error" id="uiError"></div>

    <div id="response"></div>

    <form id="queryForm">
      <div class="welcome-message" id="welcomeMessage"></div>

      <textarea id="query" placeholder="Wpisz pytanie..." class="input-field w-full"></textarea>

      <div class="controls-row">
        <div class="branch-controls" id="branchControls">
          <!-- Rendered by JS -->
        </div>
        <div class="controls-spacer" id="controlsSpacer"></div>

        <div class="actions-controls">
          <select id="lang" class="select-field lang-select">
            <option value="pl">PL Rozmawiaj po polsku</option>
            <option value="en">EN English (no translation)</option>
          </select>

          <button type="submit" class="send-btn" id="sendBtn">Wy≈õlij</button>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-backdrop" id="snapshotModalBackdrop" style="display:none;">
    <div class="modal">
      <div class="modal-title" id="snapshotModalTitle">Potwierdzenie</div>
      <div class="modal-body" id="snapshotModalBody"></div>
      <div class="modal-actions">
        <button type="button" class="modal-btn cancel" id="snapshotModalCancel">Anuluj</button>
        <button type="button" class="modal-btn confirm" id="snapshotModalConfirm">OK</button>
      </div>
    </div>
  </div>

<script>
  // English comments only.

  const API_BASE = (window.location.protocol === "file:")
    ? "http://localhost:8081"
    : window.location.origin;
  const URL_MODE = (new URLSearchParams(window.location.search).get("mode") || "dev").toLowerCase();
  const IS_FILE_MODE = window.location.protocol === "file:";
  const APP_MODE = (URL_MODE === "prod") ? "prod" : "dev";
  const APP_CONFIG_PATH = IS_FILE_MODE ? "/app-config" : `/app-config/${APP_MODE}`;
  const SEARCH_PATH = IS_FILE_MODE ? "/search" : `/search/${APP_MODE}`;

  let sessionId = localStorage.getItem("sessionId") || null;

  let selectedConsultant = null;
  let appConfig = null;
  let consultantsById = {};
  let snapshotPolicy = "single";
  let currentSnapshotSetId = localStorage.getItem("snapshotSetId") || null;
  let currentSnapshotId = localStorage.getItem("snapshotId") || null;
  let currentSnapshotLabel = localStorage.getItem("snapshotLabel") || null;
  let conversationSnapshotSetId = localStorage.getItem("conversationSnapshotSetId") || null;

  let selectedSnapshotA = null;
  let selectedSnapshotB = null;

  let fakeAuthEnabled = false;
  const DEV_AUTH_USER_ID = "dev-user-1";

  const form = document.getElementById("queryForm");
  const queryInput = document.getElementById("query");
  const responseDiv = document.getElementById("response");
  const submitButton = document.getElementById("sendBtn");
  const welcomeMessage = document.getElementById("welcomeMessage");
  const langSelect = document.getElementById("lang");
  const consultantsContainer = document.getElementById("consultants");
  const newChatBtn = document.getElementById("newChatBtn");
  const uiError = document.getElementById("uiError");
  const branchControls = document.getElementById("branchControls");
  const controlsSpacer = document.getElementById("controlsSpacer");
  const authToggleBtn = document.getElementById("authToggleBtn");
  const snapshotModalBackdrop = document.getElementById("snapshotModalBackdrop");
  const snapshotModalTitle = document.getElementById("snapshotModalTitle");
  const snapshotModalBody = document.getElementById("snapshotModalBody");
  const snapshotModalCancel = document.getElementById("snapshotModalCancel");
  const snapshotModalConfirm = document.getElementById("snapshotModalConfirm");

  // If name is longer than this, we shorten it in CLOSED state.
  // In compare mode we also shorten even if it's below the threshold (to make differences obvious).
  const MAX_BRANCH_LABEL_LEN = 28;

  const uiTexts = {
    pl: {
      send: "Wy≈õlij",
      wait: "Czekaj...",
      error: "WystƒÖpi≈Ç b≈ÇƒÖd podczas przetwarzania zapytania.",
      noResponse: "Brak odpowiedzi",
      ask: "zapytanie",
      placeholder: "Wpisz pytanie...",
      newChat: "‚ôªÔ∏è Nowy Chat",
      locale: "pl-PL",
      copy: "Kopiuj",
      copied: "Skopiowano!",
      snapshotLabel: "Wersja",
      snapshotDisabled: "no retrieval",
      vs: "vs",
      compareChooseTwo: "Wybierz dwa snapshoty do por√≥wnania.",
      compareChooseDifferent: "W trybie por√≥wnania wybierz dwa r√≥≈ºne snapshoty.",
      queryTooLong: "Za d≈Çugie zapytanie",
      snapshotChangeSingleTitle: "RozpoczƒÖƒá nowƒÖ rozmowƒô?",
      snapshotChangeSingleBody: "Wskazany konsultant korzysta z innego zakresu wersji. ≈ªeby siƒô prze≈ÇƒÖczyƒá rozpocznij nowƒÖ rozmowƒô.",
	      snapshotChangeMultiTitle: "Zmieniƒá zakres wersji?",
	      snapshotChangeMultiBody: "Zmiana zakresu wersji w trakcie tej samej rozmowy mo≈ºe pomieszaƒá kontekst. Kontynuowaƒá?",
	      snapshotChanged: (from, to) => `Zmieniono wersjƒô: ${from} ‚Üí ${to}`,
	      modalConfirm: "Nowa rozmowa",
	      modalCancel: "Anuluj",
	      modalContinue: "Kontynuuj"
	    },
	    en: {
      send: "Send",
      wait: "Please wait...",
      error: "An error occurred while processing the request.",
      noResponse: "No response",
      ask: "query",
      placeholder: "Type your question...",
      newChat: "‚ôªÔ∏è New Chat",
      locale: "en-GB",
      copy: "Copy",
      copied: "Copied!",
      snapshotLabel: "Version",
      snapshotDisabled: "no retrieval",
      vs: "vs",
      compareChooseTwo: "Choose two snapshots to compare.",
      compareChooseDifferent: "In compare mode, choose two different snapshots.",
      queryTooLong: "Query is too long",
      snapshotChangeSingleTitle: "Start a new chat?",
      snapshotChangeSingleBody: "The selected consultant uses a different version scope. To switch, start a new chat.",
	      snapshotChangeMultiTitle: "Change version scope?",
	      snapshotChangeMultiBody: "Changing the version scope within the same chat may mix context. Continue?",
	      snapshotChanged: (from, to) => `Snapshot changed: ${from} ‚Üí ${to}`,
	      modalConfirm: "Start new chat",
	      modalCancel: "Cancel",
	      modalContinue: "Continue"
	    }
	  };

  function showUiError(msg) {
    if (!uiError) return;
    uiError.textContent = msg || "";
    uiError.style.display = msg ? "block" : "none";
  }

  function getCurrentLang() {
    return localStorage.getItem("lang") || (langSelect?.value || "pl");
  }

  function getTexts(lang) {
    return uiTexts[lang] || uiTexts.pl;
  }

  async function fetchAppConfig() {
    const authHeaders = {};
    if (fakeAuthEnabled) {
      authHeaders["Authorization"] = `Bearer dev-user:${DEV_AUTH_USER_ID}`;
    }

    const res = await fetch(`${API_BASE}${APP_CONFIG_PATH}`, {
      headers: {
        ...authHeaders,
      }
    });
    if (!res.ok) throw new Error(`GET ${APP_CONFIG_PATH} failed: ${res.status}`);
    return await res.json();
  }

  function rebuildConsultantsIndex() {
    consultantsById = {};
    for (const c of (appConfig?.consultants || [])) {
      consultantsById[c.id] = c;
    }
    snapshotPolicy = String(appConfig?.snapshotPolicy || "single").trim() || "single";
  }

  function buildConsultantsBar(lang) {
    consultantsContainer.innerHTML = "";

    for (const c of (appConfig?.consultants || [])) {
      const desc = c.cardDescription?.[lang] || c.cardDescription?.pl || "";

      const card = document.createElement("div");
      card.className = "consultant-card";
      card.setAttribute("data-consultant-id", c.id);
      card.addEventListener("click", () => selectConsultant(c.id));

      const icon = document.createElement("div");
      icon.className = "consultant-icon";
      icon.textContent = c.icon || "üë§";

      const textWrap = document.createElement("div");
      textWrap.className = "consultant-text";

      const nameSpan = document.createElement("div");
      nameSpan.className = "consultant-name";
      nameSpan.textContent = c.displayName || c.id;

      const small = document.createElement("div");
      small.className = "consultant-desc";
      small.textContent = desc;

      textWrap.appendChild(nameSpan);
      textWrap.appendChild(small);

      card.appendChild(icon);
      card.appendChild(textWrap);

      consultantsContainer.appendChild(card);
    }

    document.querySelectorAll(".consultant-card").forEach(el => {
      const id = el.getAttribute("data-consultant-id");
      el.classList.toggle("active", id === selectedConsultant);
    });
  }

  function renderWelcomeMessage(lang = getCurrentLang()) {
    const c = consultantsById[selectedConsultant];
    if (!welcomeMessage) return;

    if (!c) {
      welcomeMessage.textContent = "";
      return;
    }

    const template = c.welcomeTemplate?.[lang] || c.welcomeTemplate?.pl || "";
    const href = c.wikiUrl?.[lang] || c.wikiUrl?.pl || "";

    const linkText =
      c.welcomeLinkText?.[lang] ||
      c.welcomeLinkText?.pl ||
      c.displayName ||
      c.id;

    const parts = String(template).split("{link}");
    const before = parts[0] ?? "";
    const after = parts.slice(1).join("{link}") ?? "";

    welcomeMessage.innerHTML = "";
    welcomeMessage.appendChild(document.createTextNode(before));

    const a = document.createElement("a");
    a.href = href || "#";
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.title = (lang === "pl") ? "Wikipedia ‚Äì otwiera siƒô w nowej karcie" : "Wikipedia ‚Äì opens in new tab";
    a.textContent = linkText;

    if (!href) {
      a.removeAttribute("href");
      a.style.textDecoration = "none";
      a.style.color = "inherit";
      a.style.cursor = "default";
    }

    welcomeMessage.appendChild(a);
    welcomeMessage.appendChild(document.createTextNode(after));
  }

  function firstSnapshotOrNull(list) {
    return list && list.length ? list[0] : null;
  }

  function getConsultantSnapshots(c) {
    return Array.isArray(c?.snapshots) ? c.snapshots : [];
  }

  function hasSnapshots(c) {
    return getConsultantSnapshots(c).length > 0;
  }

  function getSnapshotSetId(c) {
    const sid = String(c?.snapshotSetId || "").trim();
    return sid || null;
  }

  function updateSnapshotState(id, label, snapshotSetId) {
    if (id) {
      currentSnapshotId = id;
      localStorage.setItem("snapshotId", id);
    }
    if (label) {
      currentSnapshotLabel = label;
      localStorage.setItem("snapshotLabel", label);
    }
    if (snapshotSetId) {
      currentSnapshotSetId = snapshotSetId;
      localStorage.setItem("snapshotSetId", snapshotSetId);
    }
  }

  function hasActiveConversation() {
    return responseDiv && responseDiv.children && responseDiv.children.length > 0;
  }

  function showSnapshotModal(title, message, onConfirm, onCancel, confirmLabel) {
    if (!snapshotModalBackdrop) {
      const ok = confirm(`${title}\n\n${message}`);
      if (ok) onConfirm();
      else if (onCancel) onCancel();
      return;
    }
    const t = getTexts(getCurrentLang());
    snapshotModalTitle.textContent = title;
    snapshotModalBody.textContent = message;
    snapshotModalConfirm.textContent = confirmLabel || t.modalConfirm || "OK";
    snapshotModalCancel.textContent = t.modalCancel || "Anuluj";
    snapshotModalBackdrop.style.display = "flex";

    const cleanup = () => {
      snapshotModalBackdrop.style.display = "none";
      snapshotModalConfirm.onclick = null;
      snapshotModalCancel.onclick = null;
    };

    snapshotModalConfirm.onclick = () => {
      cleanup();
      onConfirm();
    };
    snapshotModalCancel.onclick = () => {
      cleanup();
      if (onCancel) onCancel();
    };
  }

  function addSystemMessage(text) {
    const lang = getCurrentLang();
    const t = getTexts(lang);
    const timestamp = new Date().toLocaleString(t.locale);
    const html = `
      <div class="bg-yellow-50 p-4 rounded-xl shadow-sm border border-yellow-200 response-entry">
        <div class="text-sm text-yellow-800 mb-2">${timestamp}</div>
        <div class="text-sm text-yellow-900">${escapeHtml(text)}</div>
      </div>
    `;
    responseDiv.innerHTML = html + responseDiv.innerHTML;
  }

  // Autosize select width to its selected option text (clamped).
  const __selectMeasureSpan = (() => {
    const s = document.createElement("span");
    s.style.position = "absolute";
    s.style.visibility = "hidden";
    s.style.whiteSpace = "pre";
    s.style.top = "-9999px";
    s.style.left = "-9999px";
    document.body.appendChild(s);
    return s;
  })();

  function autoSizeSelectToValue(selectEl, opts = {}) {
    if (!selectEl) return;

    const minPx = opts.minPx ?? 160;
    const maxPx = opts.maxPx ?? 520;

    const text = selectEl.options?.[selectEl.selectedIndex]?.text ?? "";
    const cs = window.getComputedStyle(selectEl);

    __selectMeasureSpan.style.fontFamily = cs.fontFamily;
    __selectMeasureSpan.style.fontSize = cs.fontSize;
    __selectMeasureSpan.style.fontWeight = cs.fontWeight;
    __selectMeasureSpan.style.letterSpacing = cs.letterSpacing;

    __selectMeasureSpan.textContent = text;

    const textWidth = __selectMeasureSpan.getBoundingClientRect().width;

    // Room for paddings + native arrow + safety.
    const extra = 80;

    const target = Math.ceil(textWidth + extra);
    const clamped = Math.max(minPx, Math.min(maxPx, target));

    selectEl.style.width = `${clamped}px`;
  }

  function autoSizeAllBranchSelects() {
    document.querySelectorAll("select.branch-select").forEach(sel => autoSizeSelectToValue(sel));
  }

  function commonPrefixLen(strings) {
    if (!strings || strings.length === 0) return 0;
    const s0 = String(strings[0] ?? "");
    let i = 0;
    while (i < s0.length) {
      const ch = s0[i];
      for (let k = 1; k < strings.length; k++) {
        const sk = String(strings[k] ?? "");
        if (i >= sk.length || sk[i] !== ch) return i;
      }
      i++;
    }
    return i;
  }

  function commonSuffixLen(strings) {
    if (!strings || strings.length === 0) return 0;
    const s0 = String(strings[0] ?? "");
    let i = 0;
    while (i < s0.length) {
      const ch = s0[s0.length - 1 - i];
      for (let k = 1; k < strings.length; k++) {
        const sk = String(strings[k] ?? "");
        if (i >= sk.length || sk[sk.length - 1 - i] !== ch) return i;
      }
      i++;
    }
    return i;
  }

  function trimLeadingSeparators(s) {
    return String(s).replace(/^[_\-.\/\\\s]+/, "");
  }

  function trimTrailingSeparators(s) {
    return String(s).replace(/[_\-.\/\\\s]+$/, "");
  }

  function computeClosedBranchLabel(fullName, mode, allLabels) {
    const name = String(fullName ?? "");
    if (!name) return "";

    const inCompare = (mode === "compare");

    // Single mode: show full if "reasonable".
    // Compare mode: force smart-shortening to make A vs B obvious.
    const shouldShorten = inCompare || (name.length > MAX_BRANCH_LABEL_LEN);
    if (!shouldShorten) return name;

    if (!Array.isArray(allLabels) || allLabels.length <= 1) {
      if (name.length <= MAX_BRANCH_LABEL_LEN) return name;
      return "‚Ä¶" + name.slice(-(MAX_BRANCH_LABEL_LEN - 1));
    }

    const pref = commonPrefixLen(allLabels);
    const suff = commonSuffixLen(allLabels);

    // Candidate A: cut common PREFIX, keep the differing tail.
    let candPrefix = null;
    if (pref > 0 && pref < name.length) {
      const tail = trimLeadingSeparators(name.slice(pref));
      if (tail) candPrefix = "‚Ä¶" + tail;
    }

    // Candidate B: cut common SUFFIX, keep the differing head.
    let candSuffix = null;
    if (suff > 0 && suff < name.length) {
      const head = trimTrailingSeparators(name.slice(0, name.length - suff));
      if (head) candSuffix = head + "‚Ä¶";
    }

    // Prefer cutting the side that is more common across all names.
    let chosen = null;
    if (pref >= suff) {
      chosen = candPrefix || candSuffix || name;
    } else {
      chosen = candSuffix || candPrefix || name;
    }

    if (chosen.length <= MAX_BRANCH_LABEL_LEN) return chosen;

    if (chosen.startsWith("‚Ä¶")) {
      return "‚Ä¶" + name.slice(-(MAX_BRANCH_LABEL_LEN - 1));
    }
    return name.slice(0, MAX_BRANCH_LABEL_LEN - 1) + "‚Ä¶";
  }

  function setAllOptionsToFull(selectEl) {
    if (!selectEl) return;
    for (const opt of selectEl.options) {
      const full = opt.getAttribute("data-full");
      if (full != null) opt.textContent = full;
    }
  }

  function applyClosedLabelToSelected(selectEl, mode, allLabels) {
    if (!selectEl) return;

    setAllOptionsToFull(selectEl);

    const opt = selectEl.options?.[selectEl.selectedIndex];
    const full = String(opt?.getAttribute("data-full") ?? "");
    const label = computeClosedBranchLabel(full, mode, allLabels);

    if (opt) opt.textContent = label;

    selectEl.title = full || "";

    autoSizeSelectToValue(selectEl);
  }

  function prepareOpenSelect(selectEl) {
    setAllOptionsToFull(selectEl);
  }

  function updateSendButtonState() {
    const lang = getCurrentLang();
    const t = getTexts(lang);

    const c = consultantsById[selectedConsultant];
    const mode = (c && (c.snapshotPickerMode || c.branchPickerMode)) ? (c.snapshotPickerMode || c.branchPickerMode) : "single";

    if (!submitButton) return;

    // Default: enabled.
    submitButton.disabled = false;
    submitButton.title = "";

    if (mode !== "compare") return;

    // Compare mode: must have 2 different snapshots.
    let effectiveA = selectedSnapshotA;
    let effectiveB = selectedSnapshotB;
    const selects = branchControls ? branchControls.querySelectorAll(".branch-select") : [];
    if (selects && selects.length >= 2) {
      effectiveA = selects[0].value || effectiveA;
      effectiveB = selects[1].value || effectiveB;
    }

    if (!effectiveA || !effectiveB) {
      submitButton.disabled = true;
      submitButton.title = t.compareChooseTwo;
      return;
    }

    if (effectiveA === effectiveB) {
      submitButton.disabled = true;
      submitButton.title = t.compareChooseDifferent;
      return;
    }
  }

  function renderBranchControls() {
    const lang = getCurrentLang();
    const t = getTexts(lang);
    const c = consultantsById[selectedConsultant];

    branchControls.innerHTML = "";
    branchControls.style.display = "";
    if (controlsSpacer) controlsSpacer.style.display = "none";

    const mode = (c && (c.snapshotPickerMode || c.branchPickerMode)) ? (c.snapshotPickerMode || c.branchPickerMode) : "single";
    if (!hasSnapshots(c) || mode === "none") {
      selectedSnapshotA = null;
      selectedSnapshotB = null;
      branchControls.style.display = "none";
      if (controlsSpacer) controlsSpacer.style.display = "block";
      updateSendButtonState();
      return;
    }

    const label = document.createElement("div");
    label.className = "branch-label";
    label.innerHTML = `üîÄ <span>${t.snapshotLabel}</span>`;
    branchControls.appendChild(label);

    branchControls.classList.toggle("compare", mode === "compare");

    const snapshots = getConsultantSnapshots(c);
    if (!selectedSnapshotA) {
      selectedSnapshotA = firstSnapshotOrNull(snapshots)?.id || null;
    }
    if (mode === "compare") {
      if (!selectedSnapshotB) {
        const second = snapshots.length > 1 ? snapshots[1] : snapshots[0];
        selectedSnapshotB = (second && second.id) ? second.id : null;
      }
    } else {
      selectedSnapshotB = null;
    }

    updateSendButtonState();

    const makeSelect = (options, currentValue, onChange) => {
      const sel = document.createElement("select");
      sel.className = "branch-select";

      for (const optItem of options) {
        const opt = document.createElement("option");
        opt.value = optItem.value;
        opt.textContent = optItem.label;
        opt.setAttribute("data-full", optItem.label);
        sel.appendChild(opt);
      }

      const values = options.map(o => o.value);
      if (currentValue && values.includes(currentValue)) {
        sel.value = currentValue;
      } else if (options.length) {
        sel.value = options[0].value;
      }

      sel.addEventListener("focus", () => prepareOpenSelect(sel));
      sel.addEventListener("mousedown", () => prepareOpenSelect(sel));
      sel.addEventListener("keydown", (e) => {
        if (e.key === "ArrowDown" || e.key === " " || e.key === "Enter") {
          prepareOpenSelect(sel);
        }
      });

      sel.addEventListener("change", (e) => {
        onChange(e.target.value);
        updateSendButtonState();
        setTimeout(() => applyClosedLabelToSelected(sel, mode, options.map(o => o.label)), 0);
      });

      sel.addEventListener("blur", () => applyClosedLabelToSelected(sel, mode, options.map(o => o.label)));

      applyClosedLabelToSelected(sel, mode, options.map(o => o.label));

      return sel;
    };

    {
      const snapSet = getSnapshotSetId(c);
      if (snapSet && currentSnapshotSetId && snapSet === currentSnapshotSetId && !selectedSnapshotA) {
        selectedSnapshotA = currentSnapshotId;
      }
      const snapshotOptions = snapshots.map(s => ({
        value: s.id,
        label: s.label || s.id,
      }));
      const selA = makeSelect(snapshotOptions, selectedSnapshotA, v => {
        const prevId = selectedSnapshotA;
        const prevLabel = currentSnapshotLabel || prevId;
        selectedSnapshotA = v;
        const chosen = snapshots.find(s => s.id === v);
        const nextLabel = chosen?.label || v;
        updateSnapshotState(v, nextLabel, getSnapshotSetId(c));
        if (responseDiv.children.length > 0 && prevId && prevId !== v) {
          const t = getTexts(getCurrentLang());
          const from = prevLabel || prevId;
          addSystemMessage(
            (typeof t.snapshotChanged === "function")
              ? t.snapshotChanged(from, nextLabel)
              : `Snapshot changed: ${from} ‚Üí ${nextLabel}`
          );
        }
      });
      branchControls.appendChild(selA);

      if (mode === "compare") {
        const vs = document.createElement("div");
        vs.className = "vs-badge";
        vs.textContent = t.vs;
        branchControls.appendChild(vs);

        const selB = makeSelect(snapshotOptions, selectedSnapshotB, v => {
          selectedSnapshotB = v;
        });
        branchControls.appendChild(selB);
      }

      requestAnimationFrame(autoSizeAllBranchSelects);
      return;
    }

    requestAnimationFrame(autoSizeAllBranchSelects);
  }

  function refreshCopyButtonsText(lang) {
    const t = getTexts(lang);
    document.querySelectorAll(".copy-btn").forEach(btn => {
      const isCopied = btn.classList.contains("copied");
      btn.textContent = isCopied ? t.copied : t.copy;
    });
  }

  function applyLang(lang) {
    const t = getTexts(lang);

    if (submitButton) submitButton.innerText = t.send;
    if (queryInput) queryInput.placeholder = t.placeholder;
    if (newChatBtn) newChatBtn.textContent = t.newChat;
    if (authToggleBtn) {
      authToggleBtn.textContent = fakeAuthEnabled ? "Fake Logout" : "Fake Login";
    }

    localStorage.setItem("lang", lang);
    if (langSelect && langSelect.value !== lang) langSelect.value = lang;

    buildConsultantsBar(lang);
    renderWelcomeMessage(lang);
    renderBranchControls();

    // Fix: existing copy buttons must update when language changes.
    refreshCopyButtonsText(lang);
  }

  function selectConsultant(id) {
    const prevConsultant = selectedConsultant;
    const prev = consultantsById[prevConsultant];
    const next = consultantsById[id];
    const prevSet = getSnapshotSetId(prev);
    const nextSet = getSnapshotSetId(next);
    const effectivePrevSet = conversationSnapshotSetId;

    // Only enforce when the conversation already used a non-empty snapshot set.
    if (nextSet && effectivePrevSet && nextSet !== effectivePrevSet && hasActiveConversation()) {
      if (snapshotPolicy === "single") {
        const t = getTexts(getCurrentLang());
        showSnapshotModal(
          t.snapshotChangeSingleTitle,
          t.snapshotChangeSingleBody,
          () => {
            newChat();
            currentSnapshotSetId = nextSet;
            localStorage.setItem("snapshotSetId", nextSet);
            selectedSnapshotA = null;
            selectedSnapshotB = null;
            proceedSelectConsultant(id);
          },
          null,
          t.modalConfirm
        );
        return;
      } else if (snapshotPolicy === "multi_confirm") {
        const t = getTexts(getCurrentLang());
        showSnapshotModal(
          t.snapshotChangeMultiTitle,
          t.snapshotChangeMultiBody,
          () => {
            if (hasActiveConversation()) {
              addSystemMessage(`SnapshotSet changed: ${prevSet} ‚Üí ${nextSet}`);
            }
            currentSnapshotSetId = nextSet;
            localStorage.setItem("snapshotSetId", nextSet);
            selectedSnapshotA = null;
            selectedSnapshotB = null;
            proceedSelectConsultant(id);
          },
          null,
          t.modalContinue
        );
        return;
      }
    }

    proceedSelectConsultant(id);
  }

  function proceedSelectConsultant(id) {
    selectedConsultant = id;

    document.querySelectorAll(".consultant-card").forEach(el => {
      const cid = el.getAttribute("data-consultant-id");
      el.classList.toggle("active", cid === id);
    });

    renderWelcomeMessage(getCurrentLang());
    renderBranchControls();
    updateSendButtonState();
  }

  function newChat() {
    sessionId = null;
    localStorage.removeItem("sessionId");
    conversationSnapshotSetId = null;
    localStorage.removeItem("conversationSnapshotSetId");
    responseDiv.innerHTML = "";
    updateFormPosition();
    updateSendButtonState();
  }

  function updateFormPosition() {
    const isEmpty = responseDiv.children.length === 0;
    form.classList.toggle("centered", isEmpty);
  }

  function addCopyButtons() {
    document.querySelectorAll("pre").forEach(pre => {
      if (pre.querySelector(".copy-btn")) return;

      const button = document.createElement("button");
      button.className = "copy-btn";
      const t = getTexts(getCurrentLang());
      button.textContent = t.copy;

      button.addEventListener("click", e => {
        e.preventDefault();
        const code = pre.querySelector("code")?.textContent || "";
        navigator.clipboard.writeText(code).then(() => {
          const t2 = getTexts(getCurrentLang());
          button.textContent = t2.copied;
          button.classList.add("copied");
          setTimeout(() => {
            const t3 = getTexts(getCurrentLang());
            button.textContent = t3.copy;
            button.classList.remove("copied");
          }, 2000);
        });
      });

      pre.appendChild(button);
    });
  }

  function scrollToLatestResponse() {
    if (responseDiv.firstChild) {
      responseDiv.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      }
      return hljs.highlightAuto(code).value;
    }
  });

  async function handleSubmit(e) {
    e.preventDefault();
    const lang = getCurrentLang();
    const t = getTexts(lang);

    let query = (queryInput.value || "").trim();
    if (!query || query.length > 1000) {
      if (query.length > 1000) alert(t.error + " (" + t.queryTooLong + ")");
      return;
    }

    submitButton.disabled = true;
    submitButton.innerText = t.wait;

    const c = consultantsById[selectedConsultant];
    const mode = (c && (c.snapshotPickerMode || c.branchPickerMode)) ? (c.snapshotPickerMode || c.branchPickerMode) : "single";
    const snapshotsPayload = [];
    if (hasSnapshots(c)) {
      if (selectedSnapshotA) snapshotsPayload.push(selectedSnapshotA);
      if (mode === "compare" && selectedSnapshotB) snapshotsPayload.push(selectedSnapshotB);

      if (snapshotsPayload.length === 2 && snapshotsPayload[0] === snapshotsPayload[1]) {
        alert(t.compareChooseDifferent);
        submitButton.disabled = false;
        submitButton.innerText = t.send;
        return;
      }
    }

    const body = {
      query: query,
      consultant: selectedConsultant,
      translateChat: (lang === "pl"),
    };

    if (hasSnapshots(c)) {
      const snapSet = getSnapshotSetId(c);
      if (snapSet) body.snapshot_set_id = snapSet;
      body.snapshots = snapshotsPayload;
    } else {
      body.snapshots = [];
    }

    try {
      const authHeaders = {};
      if (fakeAuthEnabled) {
        authHeaders["Authorization"] = `Bearer dev-user:${DEV_AUTH_USER_ID}`;
      }

      const res = await fetch(`${API_BASE}${SEARCH_PATH}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...authHeaders,
          ...(sessionId ? { "X-Session-ID": sessionId } : {})
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error(`POST ${SEARCH_PATH} failed: ${res.status}`);

      const json = await res.json();
      if (json.session_id) {
        sessionId = json.session_id;
        localStorage.setItem("sessionId", sessionId);
      }

      const markdown = json.results || t.noResponse;
      const html = marked.parse(markdown);
      const timestamp = new Date().toLocaleString(t.locale);

      const questionHTML = `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 response-entry">
          <div class="text-sm text-gray-500 mb-2">
            ${timestamp} ${t.ask}: <i>${escapeHtml(query)}</i>
          </div>
          <div class="markdown-content text-gray-900">${html}</div>
        </div>
      `;

      responseDiv.innerHTML = questionHTML + responseDiv.innerHTML;
      if (body.snapshots && body.snapshots.length > 0 && body.snapshot_set_id) {
        conversationSnapshotSetId = body.snapshot_set_id;
        localStorage.setItem("conversationSnapshotSetId", conversationSnapshotSetId);
      }
      queryInput.value = "";
      addCopyButtons();
      scrollToLatestResponse();
    } catch (error) {
      console.error("submit:", error);
      alert(t.error);
    } finally {
      submitButton.disabled = false;
      submitButton.innerText = t.send;
      updateFormPosition();
      localStorage.setItem("lang", lang);
      updateSendButtonState();
    }
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function bootstrapUi() {
    try {
      showUiError("");

      // Auth state must be set before fetching /app-config.
      fakeAuthEnabled = localStorage.getItem("fakeAuthEnabled") === "1";
      if (authToggleBtn) {
        authToggleBtn.classList.toggle("active", fakeAuthEnabled);
        authToggleBtn.textContent = fakeAuthEnabled ? "Fake Logout" : "Fake Login";
      }

      appConfig = await fetchAppConfig();
      rebuildConsultantsIndex();

      selectedConsultant =
        appConfig.defaultConsultantId ||
        (appConfig.consultants?.[0]?.id ?? null);

      selectedSnapshotA = null;
      selectedSnapshotB = null;

      const savedLang = getCurrentLang();
      applyLang(savedLang);

      updateFormPosition();
      queryInput.focus();
      updateSendButtonState();
    } catch (e) {
      console.error("bootstrapUi:", e);
      showUiError(
        `Failed to load configuration from ${API_BASE}${APP_CONFIG_PATH}. ` +
        `If you opened this page as a local file (file://), start the mock server (server.js) on http://localhost:8081 and refresh the page.`
      );
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (langSelect) {
      const savedLang = getCurrentLang();
      langSelect.value = savedLang;
      langSelect.addEventListener("change", e => applyLang(e.target.value));
    }

    window.addEventListener("resize", () => {
      autoSizeAllBranchSelects();
    });

    form.addEventListener("submit", handleSubmit);

    if (authToggleBtn) {
      authToggleBtn.addEventListener("click", () => {
        fakeAuthEnabled = !fakeAuthEnabled;
        localStorage.setItem("fakeAuthEnabled", fakeAuthEnabled ? "1" : "0");
        authToggleBtn.classList.toggle("active", fakeAuthEnabled);
        authToggleBtn.textContent = fakeAuthEnabled ? "Fake Logout" : "Fake Login";
        bootstrapUi();
      });
    }

    queryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit", { cancelable: true }));
      }
    });

    bootstrapUi();
  });
</script>

</body>
</html>
