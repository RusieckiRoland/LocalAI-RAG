YAMLpipeline:
  name: marian_rejewski_code_analysis_base

  settings:
    entry_step_id: maybe_translate_in
    model_language: en

    # Defaults (must be overridden in child pipeline)
    repository: ""
    active_index: ""

    # Loop guard
    max_turn_loops: 4

    # Token budgets
    max_context_tokens: 5000
    max_history_tokens: 800

    # Rolling summary policy
    history_summarization_policy: "incremental_resummarize"

    # Graph expansion defaults
    graph_max_depth: 2
    graph_max_nodes: 120
    graph_edge_allowlist:
      - "ReadsFrom"
      - "WritesTo"
      - "Calls"
      - "Executes"
      - "FK"
      - "On"
      - "SynonymFor"
      - "ReferencedBy(C#)"

    # How many node texts/snippets we can fetch by identity after expansion
    node_text_fetch_top_n: 12

    # Retrieval modes supported by the system
    retrieval_modes:
      - semantic
      - bm25
      - hybrid
      - semantic_rerank

  steps:
    - id: maybe_translate_in
      action: translate_in_if_needed
      next: load_history

    - id: load_history
      action: load_conversation_history
      next: call_model_router

    - id: call_model_router
      action: call_model
      prompt_key: "e2e/router_v1"
      user_parts:
      question:
        source: user_question_en
        template: "### User:\n{}\n\n"
      next: handle_router_prefix


    - id: handle_router_prefix
      action: prefix_router
      routes:
        semantic:
          prefix: "[SEMANTIC:]"
          next: fetch_semantic
        bm25:
          prefix: "[BM25:]"
          next: fetch_bm25
        direct:
          prefix: "[DIRECT:]"
          next: call_model_answer
      on_other: call_model_answer

    - id: fetch_semantic
      search_type: semantic
      action: fetch_more_context
      query_parser: JsonishQueryParser
      next: expand_dependency_tree

    - id: fetch_bm25
      search_type: bm25
      action: fetch_more_context
      query_parser: JsonishQueryParser
      next: expand_dependency_tree

    - id: expand_dependency_tree
      action: expand_dependency_tree
      active_index_from_settings: true
      max_depth_from_settings: "graph_max_depth"
      max_nodes_from_settings: "graph_max_nodes"
      edge_allowlist_from_settings: "graph_edge_allowlist"
      next: fetch_node_texts

    - id: fetch_node_texts
      action: fetch_node_texts
      top_n_from_settings: "node_text_fetch_top_n"
      next: check_context_budget

    - id: check_context_budget
      action: check_context_budget
      inputs: composed_context_for_prompt
      max_tokens_from_settings: "max_context_tokens"
      on_over_limit: call_model_summarize_context
      on_ok: call_model_answer

    - id: call_model_summarize_context
      action: call_model
      prompt_key: "rejewski/context_summarizer_v1"
      user_parts:
        evidence:
          source: context_blocks
          template: "### Evidence:\n{}\n\n"
        user_question:
          source: user_question_en
          template: "### User:\n{}\n\n"
      next: call_model_answer

    - id: call_model_answer
      action: call_model
      prompt_key: "e2e/answer_v1"
      user_parts:
        evidence:
          source: context_blocks
          template: "### Evidence:\n{}\n\n"
        user_question:
          source: user_question_en
          template: "### User:\n{}\n\n"
      next: handle_answer_prefix


    - id: handle_answer_prefix
      action: prefix_router
      routes:
        answer:
          prefix: "[Answer:]"
          next: finalize
        followup:
          prefix: "[Requesting data on:]"
          next: loop_guard
      on_other: finalize

    - id: loop_guard
      action: loop_guard
      max_turn_loops_from_settings: "max_turn_loops"
      on_allow: call_model_router
      on_deny: finalize

    - id: finalize
      action: finalize
      end: true
