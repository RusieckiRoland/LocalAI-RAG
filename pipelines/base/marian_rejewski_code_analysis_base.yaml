YAMLpipeline:
  name: marian_rejewski_code_analysis_base

  settings:
    entry_step_id: maybe_translate_in
    model_language: en

    # Defaults (must be overridden in child pipeline)

    # Loop guard
    max_turn_loops: 4

    # Token budgets
    max_context_tokens: 5000
    max_history_tokens: 800

    # Rolling summary policy
    history_summarization_policy: "incremental_resummarize"

    # Graph expansion defaults
    graph_max_depth: 2
    graph_max_nodes: 120
    graph_edge_allowlist:
      - "ReadsFrom"
      - "WritesTo"
      - "Calls"
      - "Executes"
      - "FK"
      - "On"
      - "SynonymFor"
      - "ReferencedBy(C#)"

    # How many node texts/snippets we can fetch by identity after expansion
    node_text_fetch_top_n: 12

    # Retrieval modes supported by the system
    retrieval_modes:
      - semantic
      - bm25
      - hybrid
      

  steps:
    - id: maybe_translate_in
      action: translate_in_if_needed
      next: load_history

    - id: load_history
      action: load_conversation_history
      next: call_model_router

    - id: call_model_router
      action: call_model
      prompt_key: "rejewski/router_v1"
      user_parts:
        question:
          source: user_question_en
          template: "### User:\n{}\n\n"
      next: handle_router_prefix


    - id: handle_router_prefix
      action: prefix_router
      routes:
        semantic:
          prefix: "[SEMANTIC:]"
          next: search_semantic
        bm25:
          prefix: "[BM25:]"
          next: search_bm25
        direct:
          prefix: "[DIRECT:]"
          next: call_model_answer
      on_other: call_model_answer

    - id: search_semantic
      search_type: semantic
      action: search_nodes
      top_k: 12
      query_parser: JsonishQueryParser
      next: expand_dependency_tree

    - id: search_bm25
      search_type: bm25
      action: search_nodes
      top_k: 12
      query_parser: JsonishQueryParser
      next: expand_dependency_tree

    - id: expand_dependency_tree
      action: expand_dependency_tree
      max_depth_from_settings: "graph_max_depth"
      max_nodes_from_settings: "graph_max_nodes"
      edge_allowlist_from_settings: "graph_edge_allowlist"
      next: fetch_node_texts

    - id: fetch_node_texts
      action: fetch_node_texts
      max_context_tokens: 4096
      top_n_from_settings: "node_text_fetch_top_n"
      next: manage_budget

    - id: manage_budget
      action: manage_context_budget
      on_ok: call_model_answer
      on_over: budget_loop_guard

    - id: budget_loop_guard
      action: loop_guard
      max_turn_loops_from_settings: "max_turn_loops"
      on_allow: call_summarize_context
      on_deny: call_model_answer

    - id: call_summarize_context
      action: call_model
      prompt_key: "sumarizer"
      max_output_tokens: 2000
      user_parts:
        context:
          source: context_blocks
          template: "### Context:\n{}\n\n"
        user_question:
          source: user_question_en
          template: "### User:\n{}\n\n"
      next: set_context_from_summary

    - id: set_context_from_summary
      action: set_variables
      rules:
        - set: context_blocks
          from: last_model_response
          transform: to_context_blocks
        - set: last_model_response
          value: null
      next: manage_budget

    - id: call_model_answer
      native_chat: false
      action: call_model
      prompt_key: "rejewski/answer_v1"
      user_parts:
         user_question:
          source: user_question_en
          template: "\n<<<USER_QUESTION:\n{}\nUSER_QUESTION\n\n"
         evidence:
          source: context_blocks
          template: "<<<EVIDENCE:\n{}\nEVIDENCE"       
      next: handle_answer_prefix


    - id: handle_answer_prefix
      action: prefix_router
      routes:
        answer:
          prefix: "[Answer:]"
          next: set_answer_from_last_model_response
        followup:
          prefix: "[REQUESTING DATA ON:]"
          next: loop_guard
      on_other: set_answer_from_last_model_response

    - id: loop_guard
      action: loop_guard
      max_turn_loops_from_settings: "max_turn_loops"
      on_allow: call_model_router
      on_deny: set_answer_from_last_model_response

    - id: set_answer_from_last_model_response
      action: set_variables
      rules:
        - set: answer_en
          from: last_model_response
        - set: answer_translated
          value: null
      next: translate_out

    - id: translate_out
      action: translate_out_if_needed
      next: finalize

    - id: finalize
      action: finalize
      end: true
