YAMLpipelines:
  - name: P0
    settings:
      entry_step_id: translate_in
      test: true
      max_turn_loops: 4

    steps:
      - id: translate_in
        action: translate_in_if_needed
        next: load_history

      - id: load_history
        action: load_conversation_history
        next: call_router

      - id: call_router
        action: call_model
        prompt_key: "e2e/router_v1"
        next: handle_router

      - id: handle_router
        action: handle_prefix
        bm25_prefix: "[BM25:]"
        semantic_prefix: "[SEMANTIC:]"
        hybrid_prefix: "[HYBRID:]"
        semantic_rerank_prefix: "[SEMANTIC_RERANK:]"
        direct_prefix: "[DIRECT:]"
        on_bm25: call_answer
        on_other: call_answer
        next: call_answer

      - id: call_answer
        action: call_model
        prompt_key: "e2e/answer_v1"
        next: handle_answer

      - id: handle_answer
        action: handle_prefix
        answer_prefix: "[Answer:]"
        followup_prefix: "[Requesting data on:]"
        on_answer: finalize
        on_other: finalize
        next: finalize

      - id: finalize
        action: finalize
        next: persist

      - id: persist
        action: persist_turn
        end: true

  - name: P1
    settings:
      entry_step_id: translate_in
      top_k: 2
      test: true
      max_turn_loops: 4

    steps:
      - id: translate_in
        action: translate_in_if_needed
        next: load_history

      - id: load_history
        action: load_conversation_history
        next: call_router

      - id: call_router
        action: call_model
        prompt_key: "e2e/router_v1"
        next: handle_router

      - id: handle_router
        action: handle_prefix
        bm25_prefix: "[BM25:]"
        semantic_prefix: "[SEMANTIC:]"
        hybrid_prefix: "[HYBRID:]"
        semantic_rerank_prefix: "[SEMANTIC_RERANK:]"
        direct_prefix: "[DIRECT:]"
        on_bm25: search
        on_other: call_answer
        next: call_answer

      - id: search
        action: fetch_more_context
        next: call_answer

      - id: call_answer
        action: call_model
        prompt_key: "e2e/answer_v1"
        next: handle_answer

      - id: handle_answer
        action: handle_prefix
        answer_prefix: "[Answer:]"
        followup_prefix: "[Requesting data on:]"
        on_answer: finalize
        on_other: finalize
        next: finalize

      - id: finalize
        action: finalize
        next: persist

      - id: persist
        action: persist_turn
        end: true

  - name: P2
    settings:
      entry_step_id: translate_in
      top_k: 2
      test: true
      max_turn_loops: 4
      max_depth: 2
      max_nodes: 200
      node_texts_count: 3

    steps:
      - id: translate_in
        action: translate_in_if_needed
        next: load_history

      - id: load_history
        action: load_conversation_history
        next: call_router

      - id: call_router
        action: call_model
        prompt_key: "e2e/router_v1"
        next: handle_router

      - id: handle_router
        action: handle_prefix
        bm25_prefix: "[BM25:]"
        semantic_prefix: "[SEMANTIC:]"
        hybrid_prefix: "[HYBRID:]"
        semantic_rerank_prefix: "[SEMANTIC_RERANK:]"
        direct_prefix: "[DIRECT:]"
        on_bm25: search
        on_other: call_answer
        next: call_answer

      - id: search
        action: fetch_more_context
        next: expand

      - id: expand
        action: expand_dependency_tree
        next: fetch_texts

      - id: fetch_texts
        action: fetch_node_texts
        next: call_answer

      - id: call_answer
        action: call_model
        prompt_key: "e2e/answer_v1"
        next: handle_answer

      - id: handle_answer
        action: handle_prefix
        answer_prefix: "[Answer:]"
        followup_prefix: "[Requesting data on:]"
        on_answer: finalize
        on_other: loop_guard
        next: finalize

      - id: loop_guard
        action: loop_guard
        on_allow: search
        on_deny: finalize

      - id: finalize
        action: finalize
        next: persist

      - id: persist
        action: persist_turn
        end: true

  - name: P3
    settings:
      entry_step_id: translate_in
      test: true
      max_turn_loops: 4
      max_depth: 2
      max_nodes: 200
      node_texts_count: 3

    steps:
      - id: translate_in
        action: translate_in_if_needed
        next: expand

      - id: expand
        action: expand_dependency_tree
        next: fetch_texts

      - id: fetch_texts
        action: fetch_node_texts
        next: call_answer

      - id: call_answer
        action: call_model
        prompt_key: "e2e/answer_v1"
        next: handle_answer

      - id: handle_answer
        action: handle_prefix
        answer_prefix: "[Answer:]"
        followup_prefix: "[Requesting data on:]"
        on_answer: finalize
        on_other: finalize
        next: finalize

      - id: finalize
        action: finalize
        next: persist

      - id: persist
        action: persist_turn
        end: true

  - name: P4
    settings:
      entry_step_id: load_history
      test: true
      context_budget_tokens: 100
      history_budget_tokens: 50

    steps:
      - id: load_history
        action: load_conversation_history
        next: budget

      - id: budget
        action: check_context_budget
        input: "composed_context_for_prompt"
        max_tokens_from_settings: "context_budget_tokens"
        next: call_answer

      - id: call_answer
        action: call_model
        prompt_key: "e2e/answer_v1"
        next: finalize

      - id: finalize
        action: finalize
        next: persist

      - id: persist
        action: persist_turn
        end: true
